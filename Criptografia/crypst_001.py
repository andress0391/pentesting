#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import subprocess
import time
import threading
from urllib.parse import urlparse

esperar = 0
archivoResult = "../Salida/SSL_TLS.txt"


def ejecutarTestSSL(url):
    global esperar, archivoResult
    with open(archivoResult, "w") as f:
        subprocess.call(['./testssl/testssl.sh ' + url + ' | sed -r -u "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"'],
                        shell=True,
                        stdout=f,
                        stderr=subprocess.STDOUT)
        esperar = 1
    f.close()


def examinarHTTPS():
    puertos = ""
    with open("../Salida/info_010_pscan.txt", "r") as f:
        puertos = f.readlines()
    f.close()
    for x in puertos:
        if "https\n" in x:
            return 1
    return -1


def main(url):
    global esperar
    print("================ Inicio prueba OTG-CRYPST-001 ==================\n")
    https = examinarHTTPS()
    if https == 1:
        u = urlparse(url)
        url = u.netloc

        # Ejecutar el subproceso
        hilo = threading.Thread(target=ejecutarTestSSL, args=(url,))
        hilo.start()

        # Mostrar mensaje de espera
        mensaje = "Ejecutando el análisis"
        suspension = "."
        print(mensaje, end="", flush=True)
        while esperar == 0:
            time.sleep(1)
            print(suspension, end="", flush=True)
        print("\nAnálisis finalizado!")
    else:
        print("EL servidor no tiene el puert 443 (https) disponible")
    print("================ Fin prueba OTG-CRYPST-001 ==================\n")


# Si no tiene disponible el puerto 443 para qué probar
# main("http://190.5.199.22:8082")
