#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
import time
from urllib.parse import urlparse

salida = list()


def verificarHSTS(url):
    salida.append("URL objetivo: %s\n" % url)
    print("URL objetivo: " + url)

    r = requests.head(url)
    codigo_respuesta = r.status_code

    salida.append("Código de respuesta: %s\n" % str(codigo_respuesta))
    print("Código de respuesta: " + str(codigo_respuesta))

    codigos = [200, 301, 302, 403]

    if codigo_respuesta in codigos:
        try:
            cabecera = 'Strict-Transport-Security'
            print("Buscando la cabecera HSTS (Strict-Transport-Security)")
            time.sleep(1)

            sts = r.headers[cabecera]
            noVuln = "Cabecera HSTS encontrada!\n'%s' : %s\n" % (cabecera, sts)
            salida.append(noVuln)
            print(noVuln)
        except KeyError as e:
            vulnerable = "El servidor no tiene configurado el mecanismo de seguridad HSTS.\nLa infrmación navega en texto plano!"
            salida.append(vulnerable)
            print(vulnerable)
    else:
            print("Hubo un problema en establecer la comunicación.\nCódigo : %s.\n" % codigo_respuesta)


def escribirArchivo():
    with open("Salida/httpStrict.txt", "w") as f:
        for x in salida:
            f.write(x)
    f.close()


def main(url):
    print("================ Inicio prueba OTG-CONFIG-007 ==================\n")
    u = urlparse(url)
    url = u.scheme + "://" + u.netloc + u.path
    print(url)
    verificarHSTS(url)
    escribirArchivo()
    print("================ Fin prueba OTG-CONFIG-007 ==================\n")


# url = "https://github.com/"
# url = "http://190.5.199.22:8082"
# main(url)
