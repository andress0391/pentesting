# -*- coding: utf-8 -*-

import os
from fabrica.otg import OTG

__otg__ =  "OTG-AUTHZ-003"

class AUTHZ_003(OTG):

    def __init__(self,url,dependencia=None):
        
        super().__init__(dependencia, __otg__)
        self.url = url
        self.ruta = os.getcwd() + "/src/authorization/authz_003/brutespray-output"
        self.path_brute = os.getcwd() + "/src/authorization/authz_003/"

    def port_scan(self):
        #print("url que llega:{}".format(self.url))
        os.system("sudo nmap -p 22 " + self.url + " -oG " + self.path_brute + "port_scan.gnmap")
        os.system("python " + self.path_brute + "brutespray.py -f " + self.path_brute + "port_scan.gnmap -t 5 -T 2")
    
    def check_output(self):
        if os.listdir(self.ruta)!=0:
            for archivos in os.listdir(self.ruta):
                print(archivos)
                self.file_read(archivos)
                self.delete_files(archivos)
        else:
            print("No se ecnontraron credenciales")
    
    def file_read(self,archivo):
        with open(self.ruta+"/"+archivo,"r") as file:
            for line in file:
                res = self.remplazar(line)
                print(res)                
                self.adicionarResultado(res)

    #borrar archivos para nuevas peticiones
    def delete_files(self,archivos):
        os.system("rm -r " + self.ruta + "/" + archivos)


                
    
    def remplazar(self,line):
        find = "ACCOUNT FOUND"
        replace3 = "CREDENCIALES ENCONTRADAS: SERVICIO"
        line1 = line.replace(find,replace3)
        find1 = "User"
        replace1 = "USUARIO"
        line2 = line1.replace(find1,replace1)
        find2 = "Password"
        replace2 = "CONTRASEÃ‘A"
        line3 = line2.replace(find2,replace2)
        return line3
    
    def main(self):
        print("================ Iniciando prueba OTG-AUTHZ-003 ==================\n")
        print("Buscando credenciales para servicios encontrados ...\n")
        self.port_scan()
        self.check_output()
        if self.detalles.resultado!="":
            self.adicionarRecomendaciones("Cambiar sus credenciales")
            self.adicionarRiesgo(0)
            self.almacenarBD()







# if __name__ == '__main__':
#     #url = "www.ucaldas.edu.co"
#     url = "192.168.120.31"
#     obj = AUTHZ_003(url)
#     obj.port_scan()
#     obj.check_output()





    




