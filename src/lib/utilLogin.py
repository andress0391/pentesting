#!/usr/bin/python3
# -*- encoding: utf-8 -*-

from terceros.mechanicalsoup import stateful_browser
from .Form import Form
from .Inputs import CampoForm

def iniciarSesion(url, usuarioPrueba):
    # Obtener el formulario (form) de inicio de sesi√≥n de la url dada y enviar los datos
    camposEdit, form, browser = obtenerInicioSesion(url)
    b = browser[0]
    r = browser[1]
    
    b[camposEdit[0].campoName] = usuarioPrueba[0]
    b[camposEdit[1].campoName] = usuarioPrueba[1]
    b.submit_selected()
    
    return b, r

def obtenerInicioSesion(url):
    user_agent = obtenerUserAgent()
    form = Form()

    browser = stateful_browser.StatefulBrowser(user_agent=user_agent)
    req = browser.open(url, timeout=5)

    tmp = browser.get_current_page()
    html = str(tmp)

    form.obtenerForm(url, html)
    browser.select_form('form[action="' + form.accionForm + '"]')

    campos = browser.get_current_form().print_summary().split("\n")
    # Almacenar cada campo del form seleccionado
    for i in campos:
        campo = CampoForm()
        campo.obtenerDatosCampo(campo.adaptarCampo(i))
        form.camposForm.append(campo)
    campos = form.obtenerCamposEditbles()
    campos.pop()
    
    return campos, form, [browser, req]

def obtenerUserAgent():
    import random, os

    ruta = os.getcwd()+"/diccionarios/user-agents.txt"
    agentes = list()
    with open(ruta, "r") as f:
        while True:
            f.readline()
            if f.readline() == "":
                break
            agentes.append(f.readline()[0:-1])
    f.close()
    return random.choice(agentes)
