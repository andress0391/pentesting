#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
import time
from urllib.parse import urlparse
from fabrica.config import Config

__titulo__ = "Strict Transport Security"
__descripcion__ = "El encabezado HTTP Strict Transport Security (HSTS) es un mecanismo que los sitios web tienen para comunicar a los navegadores web que todo el tráfico intercambiado con un dominio determinado siempre debe enviarse a través de https, esto ayudará a proteger la información para evitar solicitudes que no están cifradas."

class Config_007(Config):
    def __init__(self, url):
        self.url = url
        self.complejidad = 1
        
    def verificarHSTS(self):
        print("URL objetivo: " + self.url)

        r = requests.head(self.url)
        codigo_respuesta = r.status_code
        print("Código de respuesta: " + str(codigo_respuesta))

        codigos = [200, 301, 302, 403]

        if codigo_respuesta in codigos:
            try:
                cabecera = 'Strict-Transport-Security'
                print("Buscando la cabecera HSTS (Strict-Transport-Security)")
                time.sleep(1)

                sts = r.headers[cabecera]
                print("Cabecera HSTS encontrada!\n'%s' : %s\n" % (cabecera, sts))
            except KeyError:
                print("HSTS no encontrado.\nLa información puede navegar en texto plano!")
        else:
                print("Hubo un problema en establecer la comunicación.\nCódigo : %s.\n" % codigo_respuesta)
    
    def main(self):
        print("================ Inicio prueba OTG-CONFIG-007 ==================\n")
        u = urlparse(self.url)
        self.url = u.scheme + "://" + u.netloc + u.path
        self.verificarHSTS()
        print("================ Fin prueba OTG-CONFIG-007 ==================\n")


# url = "https://github.com/"
#url = "https://simca.unicauca.edu.co/simca/"
#c = Config_007(url)
#c.main()
