#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
import time
from urllib.parse import urlparse
from fabrica.otg import OTG

class Config_007(OTG):
    def __init__(self, url, dependencia=None):
        super().__init__(dependencia)
        self.url = url
        self.complejidad = 1
        
    def verificarHSTS(self):
        print("URL objetivo: " + self.url)

        r = requests.head(self.url)
        codigo_respuesta = r.status_code
        print("C贸digo de respuesta: " + str(codigo_respuesta))

        codigos = [200, 301, 302, 403]

        if codigo_respuesta in codigos:
            msj = ""
            try:
                cabecera = 'Strict-Transport-Security'
                print("Buscando la cabecera HSTS (Strict-Transport-Security)")
                time.sleep(1)

                sts = r.headers[cabecera]
                print("Cabecera HSTS encontrada!\n'%s' : %s\n" % (cabecera, sts))
            except KeyError:
                msj = "HSTS no encontrado.\nLa informaci贸n puede navegar en texto plano!"
                print(msj)
                self.adicionarResultado(msj)
        else:
                print("Hubo un problema en establecer la comunicaci贸n.\nC贸digo : %s.\n" % codigo_respuesta)
    
    def main(self):
        print("================ Inicio prueba OTG-CONFIG-007 ==================\n")
        u = urlparse(self.url)
        self.url = u.scheme + "://" + u.netloc + u.path
        self.verificarHSTS()

        if self.detalles.resultado != "":
            self.adicionarRecomendaciones("")
            self.adicionarRiesgo(0.0)
            
            return self.detalles
        else:
            return None
        print("================ Fin prueba OTG-CONFIG-007 ==================\n")


# url = "https://github.com/"
#url = "https://simca.unicauca.edu.co/simca/"
#c = Config_007(url)
#c.main()
