#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
from lxml import etree
from urllib.parse import urlparse

__titulo__ = "Archivo Cross Domain Policy"
__descripcion__ = "Las aplicaciones de Internet enriquecidas (RIA) han adoptado los archivos de políticas crossdomain.xml de Adobe para permitir el consumo de datos y servicios mediante el uso de tecnologías como Oracle Java, Silverlight y Adobe Flash. Por lo tanto, un dominio puede otorgar acceso remoto a sus servicios desde un dominio diferente. Sin embargo, a menudo los archivos de políticas que describen las restricciones de acceso están mal configurados. La mala configuración de los archivos de políticas permite ataques de falsificación de solicitudes entre sitios y puede permitir que terceros accedan a datos confidenciales para el usuario."

class Config_008(object):

    def __init__(self, url):
        self.url = url
        self.clientCross = ["clientaccesspolicy.xml", "crossdomain.xml"]
        self.complejidad = 1
    
    def peticion(self, url):
        count = 0
        if url[-1] != "/":
            url = url+"/"

        session = requests.Session()
        for xml in self.clientCross:
            req = session.get(url + xml)
            if req.status_code == 200:
                count += 1
                print("Archivo < %s > encontrado." % xml)

                with open(xml, 'wb') as file:
                    file.write(req.content)
                file.close()
        if count > 0:
            return True
        else: return False
    
    def obtenerAtributos(self, xml):
        doc = etree.parse(xml)
        contenido = dict()
        if xml == "crossdomain.xml":
            print("\nExaminando el archivo %s" % xml)
            contenido = doc.find("allow-access-from")
        else:
            pass
        self.examinar(contenido)
    
    def examinar(self, contenido):
        for key, value in contenido.items():
            if key == "domain":
                if value == "*":
                    print("El atributo 'domain' debe ser cambiado!. Valor actual -> %s" % value)
            elif key == "secure":
                if value == "false":
                    print("El atributo 'secure' debe ser cambiado!. Valor actual -> %s" % value)
            elif key == "to-ports":
                if value == "*":
                    print("El atributo 'to-ports' debe ser cambiado!. Valor actual -> %s" % value)
    
    def main(self):
        if self.peticion(self.url):
            for xml in self.clientCross:
                self.obtenerAtributos(xml)
        else:
            print("No se encontrron los archivos {} y {}".format(self.clientCross[0], self.clientCross[1]))


# url = "http://testphp.vulnweb.com"
# a = Config_008(url)
# a.main()
