#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
from src.lib.utilLogin import iniciarSesion
from fabrica.otg import OTG

__descripcion__ = "Cuando una aplicación no renueva su(s) cookie(s) de sesión después de una autenticación de usuario exitosa, podría ser posible encontrar una vulnerabilidad de SESSION FIXATION (fijación de sesión) y forzar a un usuario a utilizar una cookie conocida por el atacante. En ese caso, un atacante podría robar la sesión del usuario (hijacking)."
__otg__ = "OTG-SESS-003"

class Sess_003(OTG):
    def __init__(self, login, usuarioPrueba, dependencia=None):
        super().__init__(dependencia, __otg__)
        self.url =  login
        self.usuarioPrueba = usuarioPrueba
        self.complejidad = 1
    
    def imprimirCookie(self, cookie):
        for x in cookie:
            print(x.name, x.value, x.domain)
    
    def verificarCookie(self, cookieIni, cookieFin):
        import operator

        vulnerable = False
        tamIni = len(cookieIni)
        tamFin = len(cookieFin)

        if tamIni != tamFin:
            # Si el tamaño de las cookies cambia, no existe vulnerabilidad de fixation
            return vulnerable

        # Ordenar los valores de las cookies
        cookieIni = sorted(cookieIni.get_dict().items(), key=operator.itemgetter(0))
        cookieFin = sorted(cookieFin.get_dict().items(), key=operator.itemgetter(0))

        resultado = dict()
        for x, y in zip(cookieIni, cookieFin):
            if x[0] == y[0] and x[1] == y[1]:
                resultado.update({x[0]:x[1]})

        if len(resultado) <= 0:
            return vulnerable
        else:
            cambio = True
            return cambio
    
    def detalle(self):
        pass
    
    def main(self):
        msj = ""
        vulnerable = False
        b, r = iniciarSesion(self.url, self.usuarioPrueba)
        if r.cookies:
            vulnerable = self.verificarCookie(r.cookies, b.session.cookies)
        if vulnerable == True:
            msj = "La aplicación no realiza un manejo correcto de cookies. VULNERABLE A SESSION FIXATION"
            self.adicionarResultado(msj)
            self.adicionarRecomendaciones("")
            self.adicionarRiesgo(0.0)
            
            self.almacenarBD()
            return self.detalles
        else:
            return None
        #else:
            #print("La aplicación realiza buen manejo de cookies.")

#url = "https://simca.unicauca.edu.co/simca/"
#usuarioPrueba = ['saps_29', '990B8.29']
#url = "https://github.com/login"
#usuarioPrueba = ['pordnajela', 'Santiago9529']
#a = Sess_003(url, usuarioPrueba)
#a.main()       
