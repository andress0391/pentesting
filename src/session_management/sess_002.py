#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
from urllib.parse import urlparse
from .sess_util import Cookie

class Sess_002(object):
    def __init__(self, url):
        self.url = url
        self.cookie = None
        self.complejidad = 1
    
    def revisarHttponly(self, cookie):
        if cookie.httponly is False:
            print("Atributo 'HttpOnly' no encontrada! VULNERABLE")

    def revisarSecure(self, cookie):
        if cookie.secure is False:
            print("Atributo 'secure' no encontrada! VULNERABLE")

    def revisarPath(self, cookie):
        if cookie.path == "/":
            print("Se recomienda modificar el valor del atributo 'path', para evitar que la cookie sea enviada a cualquier aplicaciÃ³n dentro del servidor.")
        else:
            path = cookie.path.split("/")
            if len(path) == 2:
                print("Atributo 'path' debe modificarse '%s' -> '%s/'." % (cookie.path,cookie.path))

    def revisarDomain(self, cookie):
        if cookie.domine[0] == ".":
            print("La cookie puede ser usada en otros servidores que pueden ser vulnerables. Por ejemplo: test%s" % cookie.domine)
            return 
    
    def revisarExpires(self, cookie):
        if cookie.expires != None:
            print(cookie.expires)
    
    def obtenerAtributos(self, cookiesReq):
        cookies = list()
        httponly = False
        for c in cookiesReq:
            if 'httponly' in c._rest.keys() or 'HttpOnly' in c._rest.keys():
                httponly = True
            else:
                httponly = False
            cookies.append(Cookie(c.name, c.value, c.path, c.secure, httponly, c.domain, c.expires,c.discard))
            
        self.cookie = cookies

    def main(self):
        u = urlparse(self.url)
        self.url = u.scheme + "://" + u.netloc + u.path

        session = requests.Session()
        req = session.get(self.url)
        cookiesReq = req.cookies
        
        self.obtenerAtributos(cookiesReq)
        i = 1
        for c in self.cookie:
            print("Cookie %s" % i)
            self.revisarHttponly(c)
            self.revisarSecure(c)
            self.revisarPath(c)
            self.revisarDomain(c)
            self.revisarExpires(c)
            i += 1
            print()


#url = "https://simca.unicauca.edu.co/simca"
#url = "https://github.com"
#url = "http://demo.testfire.net/"
#p = Sess_002(url)
#p.main()
