#!/usr/bin/python3
# -*- encoding: utf-8 -*-

from src.modelo.conexion import ConexionDB

class Detalle(object):

    def __init__(self, id=0, id_pentest=0, id_prueba=0, riesgo=0.0, resultado="", recomendacion=""):
        self.id = id
        self.id_pentest = id_pentest
        self.id_prueba = id_prueba
        self.riesgo = riesgo
        self.resultado = resultado
        self.recomendacion = recomendacion
    
    def insert(self, objDetalle):
        conn = ConexionDB()
        cur = conn.conn.cursor()

        insert = "INSERT INTO detalle (id_pentest, id_prueba, riesgo, resultado, recomendacion) VALUES (%s, %s, %s, %s, %s)"
        cur.execute(insert, (objDetalle.id_pentest, objDetalle.id_prueba, objDetalle.riesgo, objDetalle.resultado, objDetalle.recomendacion))
        conn.conn.commit()

        cur.close()
        conn.desconectar()

    def getById(self, idd):
        conn = ConexionDB()
        cur = conn.conn.cursor()

        query = "SELECT id, id_pentest, id_prueba, riesgo, resultado, recomendacion FROM detalle WHERE id = %s"
        cur.execute(query, (idd) )
        row = cur.fetchone()

        cur.close()
        conn.desconectar()
        if row is not None:
            return Detalle(row[0], row[1], row[2], row[3], row[4], row[5])
        else: return None
    
    def getResultado(self, otg, id_pentest):
        conn = ConexionDB()
        cur = conn.conn.cursor()
        
        # query = """SELECT p.resultado FROM (SELECT id_prueba, resultado FROM detalle WHERE id_prueba = (SELECT id FROM prueba WHERE codigo = %s) AND id_pentest = %s) p"""
        query = "SELECT d.resultado FROM (SELECT id, codigo from prueba where codigo = %s) p INNER JOIN detalle d ON p.id=d.id_prueba WHERE id_pentest = %s"
        cur.execute(query, (otg, id_pentest) )
        row = cur.fetchone()

        cur.close()
        conn.desconectar()
        return row